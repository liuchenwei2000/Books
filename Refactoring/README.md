## 重构（refactoring） ##

**重构**：对软件内部结构的一种调整，目的是在不改变"软件的可察行为"的前提下，提高其可理解性，降低其修改成本。重构的目的是使软件更容易被理解和修改，而性能优化往往使代码较难理解。软件的可察行为：是指最终用户或者客户端程序员都不知道软件发生了变化但是软件功能一如既往。

重构的两个方面：1，添加新功能。2，重构代码。

添加新功能时不应该修改既有代码，只管添加新功能并且通过测试。
重构代码时就不能再添加功能，只管改进程序结构，并且不能添加任何测试（除非发现以前遗漏的东西）

重构的时机：

* 1，添加新功能时（代码的设计无法帮助我们轻松的添加所需要的新功能）。
* 2，修改bug时（为了让代码更具可读性）。
* 3，复审代码时

重构与性能：短期看来，重构的确会使软件变慢，但它使优化阶段中的软件性能调整更容易，最终还是会使软件变快的。

重构的第一步：为即将修改的代码建立一组可靠的测试环境，这些测试必须有自我检验的能力。代码区块越小，代码的功能就越容易管理，代码的处理和移植也都越轻松。

重构代码时，任何不会被修改的变量都可以被当成参数传入到新的函数，至于会被修改的变量就需格外小心。如果只有一个变量会被修改，可以把它当作返回值。
                                      
### 重构手法 ###

* **重复代码**
	
	如果在一个以上的地点看到相同的程序结构，则将它们合二为一。场合：
	* 1，同一个类中的两个函数含有相同的表达式
	* 2，同一父类的两个子类中含有相同的表达式
	* 3，不同的类中含有相同的表达式
 
* **长函数**

	每当感觉需要以注释来说明点什么的时候，就需要把说明的东西写进一个独立的函数，并以其用途命名。关键不在于函数的长度，而在于函数“做什么”和“怎么做”之间的语义距离。场合：

	如果代码前方有一行注释，这是可将这段代码替换成一个函数，而且可以在注释的基础上给这个函数命名。条件式和循环也可以提炼，可以讲循环和其内代码提炼到一个独立的函数中。

* **过大类**

	含有的实例太多，需要分解到不同的类中。

* **过长参数列**

	方法需要足够的数据，但是它不关心这些数据是以什么方式传进方法的。过长的参数列可以使用一个对象来替代进行数据传递。

* **依赖**

	若修改某个类或者某个函数总是会引起别的类或者函数发生变化，那么就要把总是一起变化的东西放到一块，保持变化只在一地发生。

* **数据泥团**

	某些类中有相同的字段，很多函数中的参数列中具有相同参数，这些总是绑在一起出现的数据都应该放到属于它们自己的对象中。如果去掉众多数据中的几个，其他数据并没有因此失去意义，那么就应该为这些去掉的数据建立一个对象。

* **switch 语句**

	switch 语句的问题在于重复，若是为它增加一个新的 case 语句，必须找到所有的 switch 并修改它们。面向对象中的多态可以优雅的解决这个问题。大多时候，一旦看到 switch 语句就应该考虑用多态来替换它。switch 语句经常根据类型码进行选择，需要的是与该类型码相关的函数或类，所以应该提炼switch 语句到一个独立的函数中，再将它搬移到需要多态性的那个类中，然后使用子类替代类型码，一旦完成这样的继承结构，就可以用多态来替换 switch 了。如果只是在单一函数中有些选择示例，那么就不必用多台了。

* **平行继承体系**
	
	当为某个 class 增加一个 subclass 的时候也必须为另一个 class 相应增加一个 subclass，这是便出现了重复。消除策略是：让一个继承体系的实体引用另一个继承体系的实体。

* **对客户端程序员没有用处的类要封装成为内部类**